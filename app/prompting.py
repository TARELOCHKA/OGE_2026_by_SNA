from .schemas import ScoreRequest

PROMPT_VERSION = "v1.0"

def build_prompt(req: ScoreRequest) -> str:
    # Важно: требуем строгий JSON
    return f"""
Оцени ученическое сочинение ОГЭ по русскому языку по критериям K1-K4.

Входные данные:
essay_type: {req.essay_type}
task_text: {req.task_text}

reference_text_essay:
{req.reference_text_essay}

essay_text:
{req.essay_text}

ВАЖНО:
Тип сочинения определяется по полю essay_type.
Ты ОБЯЗАН применять критерии, соответствующие указанному типу сочинения.


Требования к ответу:
- Верни ТОЛЬКО валидный JSON без Markdown и без пояснений вне JSON.
- Поля строго такие: K1, K1_explanation, K2, K2_explanation, K3, K3_explanation, K4, K4_explanation.

ЕСЛИ essay_type = 1 (языкознательное сочинение):

K1 (0–1). Обоснованный ответ на лингвистический вопрос.

Проверь:
— понял ли ученик смысл лингвистического вопроса;
— дан ли прямой и однозначный ответ именно на поставленный вопрос;
— относится ли ответ к языку (языковым средствам, языковым явлениям);
— корректно ли объяснено языковое явление:
   • с использованием термина ИЛИ
   • описательно (допускается без термина).

НЕ засчитывай:
— пересказ содержания текста;
— рассуждение о поступках героев;
— моральные или философские выводы без языкового анализа.

Оценивание:
1 балл — дан корректный, осмысленный языковедческий ответ.
0 баллов — ответ отсутствует, неверен или не относится к языку.

--------------------------------------------------

K2 (0–3). Примеры-иллюстрации из опорного текста.

Проверь:
— приведены ли РОВНО ДВА примера именно из опорного текста;
— являются ли примеры языковыми (слова, формы, конструкции, средства выразительности);
— подтверждают ли примеры заявленное языковое явление;
— пояснена ли роль КАЖДОГО примера;
— не дублируют ли примеры друг друга.

НЕ засчитывай:
— пересказ сюжета без языкового анализа;
— примеры без пояснения;
— примеры, не связанные с тезисом.

Оценивание:
3 балла — приведены 2 примера, оба корректны и пояснены.
2 балла — 2 примера есть, но один пояснён формально или поверхностно.
1 балл — приведён только 1 пример или оба примера слабые.
0 баллов — примеры отсутствуют или не относятся к языковому анализу.

--------------------------------------------------

K3 (0–2). Логичность и связность речи.

Проверь:
— выстроено ли рассуждение по логической схеме:
  тезис → доказательства → вывод;
— используются ли логические связки;
— нет ли смысловых противоречий или резких переходов.

Оценивание:
2 балла — логика рассуждения выстроена, нарушений нет.
1 балл — есть единичный логический недочёт.
0 баллов — логика нарушена, текст фрагментарен.

--------------------------------------------------

K4 (0–1). Композиционная стройность.

Проверь наличие:
— вступления (формулировка ответа на вопрос);
— основной части (примеры и пояснения);
— вывода (обобщение рассуждения).

Оценивание:
1 балл — композиция соблюдена полностью.
0 баллов — отсутствует вывод или нарушена структура.

------------------------------

ЕСЛИ essay_type = 2 (литературно-тематическое сочинение):

K1 (0–1). Понимание смысла фрагмента текста.

Проверь:
— понял ли ученик общий смысл предложенного фрагмента;
— корректно ли истолкована авторская мысль;
— соответствует ли объяснение содержанию опорного текста;
— не искажён ли смысл фрагмента.

НЕ засчитывай:
— пересказ фрагмента без объяснения;
— рассуждение, не связанное с данным фрагментом;
— искажение авторской позиции.

Оценивание:
1 балл — смысл фрагмента объяснён верно и осмысленно.
0 баллов — объяснение неверное, искажённое или отсутствует.

--------------------------------------------------

K2 (0–3). Примеры-иллюстрации из опорного текста.

Проверь:
— приведены ли РОВНО ДВА примера именно из опорного текста;
— подтверждают ли примеры объяснение смысла фрагмента;
— пояснена ли роль КАЖДОГО примера;
— не дублируют ли примеры друг друга по смыслу.

НЕ засчитывай:
— простой пересказ текста;
— примеры без пояснения;
— примеры, не связанные с объяснением фрагмента.

Оценивание:
3 балла — приведены 2 корректных примера, оба пояснены.
2 балла — 2 примера есть, но один пояснён формально или поверхностно.
1 балл — приведён только 1 пример или оба примера слабые.
0 баллов — примеры отсутствуют или не относятся к заданию.

--------------------------------------------------

K3 (0–2). Логичность и связность речи.

Проверь:
— последовательность изложения мыслей;
— наличие логических переходов между частями рассуждения;
— отсутствие смысловых разрывов и противоречий.

Оценивание:
2 балла — рассуждение логично и связно.
1 балл — есть единичный логический недочёт.
0 баллов — рассуждение фрагментарно или нелогично.

--------------------------------------------------

K4 (0–1). Композиционная стройность.

Проверь наличие:
— вступления (объяснение смысла фрагмента);
— основной части (примеры и пояснения);
— вывода (обобщение рассуждения).

Оценивание:
1 балл — композиция соблюдена полностью.
0 баллов — отсутствует вывод или структура нарушена.

------------------------------

ЕСЛИ essay_type = 3 (морально-нравственное рассуждение):

K1 (0–1). Ответ на нравственный вопрос.

Проверь:
— сформулирована ли чёткая и понятная позиция ученика;
— дан ли ответ именно на поставленный нравственный вопрос;
— носит ли ответ рассуждающий характер, а не является ли пересказом текста.

НЕ засчитывай:
— пересказ содержания текста без собственной позиции;
— формальный или неопределённый ответ;
— рассуждение, не связанное с вопросом.

Оценивание:
1 балл — позиция сформулирована ясно и соответствует вопросу.
0 баллов — позиция отсутствует, неясна или не относится к вопросу.

--------------------------------------------------

K2 (0–3). Аргументация.

Проверь наличие и качество аргументов:
— ОДНОГО примера из опорного текста с пояснением его роли;
— ОДНОГО примера из личного опыта ИЛИ литературы;
— связь каждого примера с позицией ученика.

Проверь:
— раскрыта ли суть каждого примера;
— пояснено ли, как именно пример подтверждает позицию;
— не подменён ли пример простым утверждением.

НЕ засчитывай:
— примеры без пояснения;
— два примера одного типа (например, оба из текста);
— абстрактные рассуждения без конкретных примеров.

Оценивание:
3 балла — оба примера приведены и пояснены.
2 балла — оба примера есть, но один пояснён поверхностно.
1 балл — приведён только один пример.
0 баллов — аргументация отсутствует.

--------------------------------------------------

K3 (0–2). Логичность и связность рассуждения.

Проверь:
— последовательность развития мысли;
— логическую связь между позицией и примерами;
— отсутствие смысловых разрывов и противоречий.

Оценивание:
2 балла — рассуждение логичное и связное.
1 балл — есть отдельный логический недочёт.
0 баллов — рассуждение фрагментарно или нелогично.

--------------------------------------------------

K4 (0–1). Композиционная стройность.

Проверь наличие:
— вступления (формулировка позиции);
— основной части (аргументы и пояснения);
— вывода (обобщение рассуждения).

Оценивание:
1 балл — композиция соблюдена полностью.
0 баллов — отсутствует вывод или нарушена структура.
- Объяснения: 2-5 предложений, по делу, со ссылкой на признаки из текста.
- Если не уверен — ставь минимальный балл и объясни, чего не хватило.

Пример формата (не копируй текст, это только пример структуры):
{{
  "K1": 1,
  "K1_explanation": "...",
  "K2": 2,
  "K2_explanation": "...",
  "K3": 1,
  "K3_explanation": "...",
  "K4": 1,
  "K4_explanation": "..."
}}
""".strip()
