from .schemas import ScoreRequest

PROMPT_VERSION = "v1.1"

def build_prompt(req: ScoreRequest) -> str:
    return f"""
Ты — эксперт по проверке сочинений ОГЭ по русскому языку.
Оцени сочинение по критериям K1–K4 строго по заданным шкалам ниже.

Ключевая цель: максимально точная и стабильная оценка по критериям.
Не угадывай: если признак не найден явно — снижай балл.

ФОРМАТ:
- Верни ТОЛЬКО валидный JSON.
- Без markdown, без комментариев вне JSON.
- Ключи строго: K1, K1_explanation, K2, K2_explanation, K3, K3_explanation, K4, K4_explanation.
- Значения K1..K4 — целые числа в допустимых диапазонах.

ПЕРЕД ОЦЕНКОЙ (мысленно, но строго):
1) Определи: есть ли позиция/ответ на вопрос (для K1).
2) Найди примеры/аргументы (для K2):
   - тип 1/2: ровно 2 примера из опорного текста + пояснение роли каждого.
   - тип 3: 1 пример из опорного текста + 1 пример из личного опыта/литературы + пояснение связи с позицией.
3) Проверь связность: тезис → доказательства → вывод (для K3).
4) Проверь композицию: вступление + основная часть + вывод (для K4).

ЕСЛИ НЕ НАШЁЛ явно:
- Для K1: нет ясного ответа/позиции → 0.
- Для K2: нет нужного количества примеров ИЛИ нет пояснения → снижать.
- Для K4: нет вывода/структура нарушена → 0.

ВХОДНЫЕ ДАННЫЕ:
essay_type: {req.essay_type}
task_text:
{req.task_text}

reference_text_essay:
{req.reference_text_essay}

essay_text:
{req.essay_text}

========================================
КРИТЕРИИ (используй ТОЛЬКО для данного essay_type)
========================================

ЕСЛИ essay_type = 1 (языкознательное сочинение):

K1 (0–1). Обоснованный ответ на лингвистический вопрос.
1 — дан корректный языковедческий ответ по вопросу (про языковые явления/средства) и объяснение.
0 — ответ отсутствует/не про язык/пересказ сюжета.

K2 (0–3). Примеры-иллюстрации из опорного текста.
Требование: 2 примера ИМЕННО из опорного текста + роль каждого примера.
3 — 2 примера корректны и роль каждого пояснена.
2 — 2 примера есть, но роль одного пояснена формально/слабо.
1 — только 1 пример ИЛИ оба слабые/без нормального пояснения.
0 — нет примеров из текста или это пересказ без языкового анализа.

K3 (0–2). Логичность и связность.
2 — тезис → доказательства → вывод, логические связки, нет противоречий.
1 — единичный логический недочёт/слабые связки.
0 — рассуждение фрагментарно/нелогично.

K4 (0–1). Композиционная стройность.
1 — есть вступление + основная часть + вывод.
0 — нет вывода или структура явно нарушена.

----------------------------------------

ЕСЛИ essay_type = 2 (литературно-тематическое сочинение):

K1 (0–1). Понимание смысла фрагмента.
1 — смысл фрагмента объяснён верно, без искажений, не просто пересказ.
0 — отсутствует/искажено/не связано с фрагментом.

K2 (0–3). Примеры-иллюстрации из опорного текста.
Требование: 2 примера ИМЕННО из опорного текста + роль каждого примера.
3 — 2 примера корректны и пояснены.
2 — 2 примера есть, но один пояснён формально/слабо.
1 — только 1 пример ИЛИ оба слабые/без пояснений.
0 — примеры отсутствуют/не по тексту/пересказ.

K3 (0–2). Логичность и связность.
2 — рассуждение связно и последовательно.
1 — единичный недочёт.
0 — фрагментарно/нелогично.

K4 (0–1). Композиционная стройность.
1 — есть вступление + основная часть + вывод.
0 — нет вывода или структура нарушена.

----------------------------------------

ЕСЛИ essay_type = 3 (морально-нравственное рассуждение):

K1 (0–1). Ответ на нравственный вопрос.
1 — позиция ученика ясная, это ответ именно на вопрос, не пересказ.
0 — позиции нет/неясно/не по вопросу.

K2 (0–3). Аргументация.
Требование: ДВА аргумента разного типа:
A) 1 пример из опорного текста + пояснение роли
B) 1 пример из личного опыта ИЛИ литературы + пояснение роли
3 — оба примера есть, разного типа, и связь с позицией объяснена.
2 — оба есть, но один пример/связь раскрыты поверхностно.
1 — приведён только 1 пример ИЛИ оба примера одного типа.
0 — аргументации нет (нет примеров или только абстрактные слова).

K3 (0–2). Логичность и связность.
2 — позиция → аргументы → вывод, всё связано.
1 — есть отдельный недочёт/слабая связка.
0 — фрагментарно/нелогично.

K4 (0–1). Композиционная стройность.
1 — есть вступление (позиция) + основная часть (аргументы) + вывод.
0 — нет вывода или структура нарушена.

========================================
ТРЕБОВАНИЯ К ОБЪЯСНЕНИЯМ:
- 2–4 предложения, строго по делу.
- Для K2 обязательно укажи: сколько найдено примеров и какого типа (для essay_type=3).
- Для K4 укажи, есть ли вывод (да/нет).
- Если снижаешь балл: кратко напиши, чего именно не хватило.

Верни JSON.
""".strip()
