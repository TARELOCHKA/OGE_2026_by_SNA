# Деплой на Amvera

## Подготовка проекта

### 1. Проверка файлов

Убедитесь, что у вас есть:
- ✅ `wsgi.py` - точка входа для WSGI (уже есть)
- ✅ `requirements.txt` - зависимости (уже есть)
- ✅ `.gitignore` - игнорирование ненужных файлов
- ✅ `data/inputs_for_scoring.csv` - данные должны быть в репозитории или генерироваться при деплое

### 2. Проверка .gitignore

Убедитесь, что `.gitignore` содержит:
```
.env
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
.venv/
venv/
env/
*.log
.DS_Store
```

### 3. Подготовка данных

**Вариант A: Включить данные в репозиторий (рекомендуется)**
```bash
# Убедитесь, что data/inputs_for_scoring.csv не в .gitignore
git add data/inputs_for_scoring.csv
```

**Вариант B: Генерировать при первом запуске**
- Скрипт `scripts/prepare_inputs.py` будет запускаться автоматически (нужно настроить в Procfile)

## Деплой на Amvera

### Шаг 1: Создание проекта на Amvera

1. Зайдите на [Amvera](https://amvera.ru/)
2. Войдите в личный кабинет
3. Нажмите "Создать проект"
4. Выберите "Flask" или "Python"
5. Подключите ваш Git репозиторий (GitHub/GitLab/Bitbucket)

### Шаг 2: Настройка переменных окружения

В настройках проекта на Amvera добавьте переменные окружения:

```
GIGACHAT_TOKEN=ваш_токен_gigachat
GIGACHAT_MODEL=GigaChat
TEMPERATURE=0.0
PROMPT_VERSION=v2
MAX_TOKENS=900
MAX_BATCH_SIZE=30
REQUEST_TIMEOUT_SEC=60
```

**Где найти:**
- В панели управления проектом → "Переменные окружения" / "Environment Variables"
- Или "Настройки" → "Конфигурация"

### Шаг 3: Настройка запуска

Amvera должен автоматически определить `wsgi.py` как точку входа.

Если это не работает, создайте файл `Procfile` в корне проекта:

```
web: gunicorn --bind 0.0.0.0:$PORT wsgi:app
```

Или укажите в настройках проекта:
- **Точка входа:** `wsgi:app`
- **Команда запуска:** `gunicorn wsgi:app`

### Шаг 4: Настройка Python версии (опционально)

Если нужно указать конкретную версию Python, создайте `runtime.txt`:

```
python-3.11.0
```

Или укажите в настройках проекта (обычно Amvera определяет автоматически).

### Шаг 5: Проверка путей к файлам

Убедитесь, что пути к файлам в `app/data_store.py` работают относительно корня проекта:

```python
# Должно быть относительным путем
def load_inputs(path: str = "data/inputs_for_scoring.csv"):
    ...
```

Если нужно, создайте данные при первом запуске (см. альтернативный вариант ниже).

### Шаг 6: Деплой

1. Закоммитьте все изменения:
   ```bash
   git add .
   git commit -m "Подготовка к деплою на Amvera"
   git push
   ```

2. Amvera автоматически определит изменения и запустит сборку

3. Дождитесь завершения деплоя

4. Проверьте приложение:
   - Откройте URL, предоставленный Amvera
   - Проверьте `/health` endpoint
   - Проверьте `/ui` - главную страницу

## Альтернативный вариант: Генерация данных при первом запуске

Если данные не включены в репозиторий, можно создать их при первом запуске:

1. Создайте файл `prestart.sh`:
   ```bash
   #!/bin/bash
   if [ ! -f "data/inputs_for_scoring.csv" ]; then
       python scripts/prepare_inputs.py
   fi
   ```

2. В настройках проекта Amvera добавьте:
   - **Команда перед запуском:** `bash prestart.sh`

## Проверка работы после деплоя

1. Откройте ваш проект на Amvera
2. Перейдите на `/health` - должен вернуться `{"status":"ok"}`
3. Перейдите на `/ui` - должна открыться главная страница
4. Попробуйте загрузить одно сочинение через UI

## Решение проблем

### Проблема: "Module not found"
- Убедитесь, что все зависимости указаны в `requirements.txt`
- Проверьте, что `gunicorn` указан в `requirements.txt`

### Проблема: "File not found: data/inputs_for_scoring.csv"
- Убедитесь, что файл есть в репозитории
- Или настройте генерацию при первом запуске (см. выше)

### Проблема: "Internal Server Error"
- Проверьте логи в панели Amvera
- Убедитесь, что все переменные окружения установлены
- Проверьте, что токен GigaChat валиден

### Проблема: Порт не определен
- Amvera автоматически устанавливает `$PORT`
- Если используете gunicorn, используйте `--bind 0.0.0.0:$PORT`

## Полезные ссылки

- [Документация Amvera](https://docs.amvera.ru/)
- [Документация Gunicorn](https://gunicorn.org/)
- [Flask Deployment](https://flask.palletsprojects.com/en/latest/deploying/)
